name: Deploy Documentation

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.14.0

      - name: ðŸ’¾ Configure pnpm cache
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ðŸ”„ Setup cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ”¨ Build project
        run: pnpm run build

      - name: ðŸ“ Copy documentation
        run: |
          # ç¡®ä¿ docs ç›®å½•å­˜åœ¨
          mkdir -p docs

          # å¤åˆ¶æ°´å°è§£æžé¡µé¢
          cp docs/watermark-decoder.html docs/index.html

          # åˆ›å»ºç®€å•çš„ README
          cat > docs/README.md << 'EOF'
          # vite-plugin-release-info Documentation

          ## æš—æ°´å°è§£æžå™¨

          è®¿é—® [æš—æ°´å°è§£æžå™¨](./watermark-decoder.html) æ¥è§£æžåº”ç”¨ä¸­çš„æš—æ°´å°ä¿¡æ¯ã€‚

          ## åŠŸèƒ½ç‰¹æ€§

          - ðŸ”’ åƒç´ çº§ RGBA æš—æ°´å°
          - ðŸ“Š å®Œæ•´å…ƒæ•°æ®è§£æž
          - âœ… æ•°æ®å®Œæ•´æ€§éªŒè¯
          - ðŸš€ æœ¬åœ°è§£æžï¼Œä¿æŠ¤éšç§

          ## ä½¿ç”¨æ–¹æ³•

          1. ä¸Šä¼ åŒ…å«æš—æ°´å°çš„å›¾ç‰‡
          2. ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹å¹¶è§£æžæ°´å°
          3. æ˜¾ç¤ºå®Œæ•´çš„æž„å»ºå…ƒæ•°æ®ä¿¡æ¯

          ## æ”¯æŒæ ¼å¼

          - PNG (æŽ¨èï¼Œæ”¯æŒ Alpha é€šé“)
          - JPG/JPEG

          ## æŠ€æœ¯åŽŸç†

          ä½¿ç”¨ LSB (Least Significant Bit) æŠ€æœ¯ï¼Œå°†æ°´å°æ•°æ®åµŒå…¥åˆ°å›¾ç‰‡çš„ Alpha é€šé“ä¸­ï¼Œ
          é€šè¿‡ä¿®æ”¹åƒç´ çš„æœ€ä½Žæœ‰æ•ˆä½æ¥å­˜å‚¨ä¿¡æ¯ï¼Œå®žçŽ°ä¸å¯è§çš„æ°´å°æ•ˆæžœã€‚
          EOF

      - name: ðŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'docs: update documentation'
